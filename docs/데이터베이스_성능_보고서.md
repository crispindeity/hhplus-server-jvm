## í™˜ê²½

- ì„œë²„ ì»¨í…Œì´ë„ˆ 2ê°œ, DB ì»¨í…Œì´ë„ˆ 2ê°œ(ì¸ë±ìŠ¤ ì ìš© DB, ì¸ë±ìŠ¤ ì ìš© ì•ˆëœ DB)
- ìœ„ êµ¬ì„±ì—ì„œ ë™ì¼í•œ ë°ì´í„°ë¥¼ DB ì— ë„£ì€ ë’¤ ì–´ëŠ ì •ë„ì˜ ì¡°íšŒ ì†ë„ ì°¨ì´ê°€ ìˆëŠ”ì§€ í™•ì¸
- ì½˜ì„œíŠ¸ í”„ë¡œì íŠ¸ íŠ¹ì„±ìƒ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì„±ëŠ¥ ê°œì„ ì˜ ì—¬ì§€ê°€ ê±°ì˜ ì—†ëŠ” ìˆ˜ì¤€ìœ¼ë¡œ, ì¸ë±ìŠ¤ê°€ ì—†ëŠ” ìƒíƒœì—ì„œë„ ëŠë¦¬ë‹¤ëŠ” ëŠë‚Œì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.

### ì°¸ê³  ì‚¬í•­

ì—¬ëŸ¬ ê¸°ëŠ¥ì—ì„œ ë°˜ë³µì ìœ¼ë¡œ ì‚¬ìš©ë˜ëŠ” ì¿¼ë¦¬ê°€ ìˆëŠ”ë° í•´ë‹¹ ì¿¼ë¦¬ëŠ” ê¸°ëŠ¥ë³„ ì¿¼ë¦¬ ë¶„ì„ì—ì„œ ë¶„ì„ ë‚´ìš©ì„ í•œë²ˆë§Œ ì‘ì„±í–ˆìŠµë‹ˆë‹¤.
SELECT, UPDATE, DELETE ì¿¼ë¦¬ë§Œ ë¶„ì„í–ˆìŠµë‹ˆë‹¤.

## ëª¨ìˆ˜(ë°ì´í„° ê°œìˆ˜)

- ì½˜ì„œíŠ¸: 20ê°œ
- ì½˜ì„œíŠ¸ ìŠ¤ì¼€ì¥´: 2000ê°œ
- ì¢Œì„: 20,000ê°œ
- ìœ ì €: 200,000ê°œ
- ì ìœ ì¤‘ì¸ ì¢Œì„: 20,000ê°œ
- ì½˜ì„œíŠ¸ ì¢Œì„: 2,000,000ê°œ
- í¬ì¸íŠ¸ ë‚´ì—­: 60,000ê°œ
- ì˜ˆì•½: 400,000ê°œ
- ëŒ€ê¸°ì—´ í† í°: 200,000ê°œ

## ê¸°ëŠ¥ë³„ ì¿¼ë¦¬ ë¶„ì„

### ì½˜ì„œíŠ¸ ì˜ˆì•½ ê°€ëŠ¥ ë‚ ì§œ ì¡°íšŒ

#### âœ… ì½˜ì„œíŠ¸ ì¡´ì¬ ìœ ë¬´ í™•ì¸

```sql
/*
ğŸ’¡ PK ë¥¼ í†µí•œ í™•ì¸ìœ¼ë¡œ í´ëŸ¬ìŠ¤í„° ì¸ë±ìŠ¤ê°€ ì´ë¯¸ ìˆê¸° ë•Œë¬¸ì— ë³„ë„ì˜ ì¸ë±ìŠ¤ëŠ” ìƒì„±í•  í•„ìš” ì—†ì„ê²ƒ ê°™ë‹¤.
*/
select count(*)
from concerts ce1_0
where ce1_0.id = ?;
```

#### âœ… ì½˜ì„œíŠ¸ ì˜ˆì•½ ê°€ëŠ¥ ë‚ ì§œ ì¡°íšŒ

```sql
/*
ğŸ’¡ì´ë²ˆ í”„ë¡œì íŠ¸ì—ì„œ ëŠë¦´ê±°ë¼ ìƒê°ë˜ëŠ” ì¿¼ë¦¬ ì¤‘ í•˜ë‚˜, ì¸ë±ìŠ¤ê°€ í•„ìš”í• ê²ƒ ê°™ë‹¤.
*/
SELECT s.id,
       s.concert_id,
       s.date,
       s.created_at,
       s.updated_at
FROM concert_schedules s
WHERE s.concert_id = ?
  AND EXISTS (SELECT 1
              FROM concert_seats cs
              WHERE cs.schedule_id = s.id
                AND cs.status = 'AVAILABLE');
```

#### ğŸ¯ ì¸ë±ìŠ¤ ì ìš© ì „, í›„ ì‹¤í–‰ ê³„íš ë¹„êµ

```text
# ì „
-> Nested loop inner join  (cost=3.98e+6 rows=39.8e+6) (actual time=561..561 rows=85 loops=1)
    -> Filter: (s.concert_id = 1)  (cost=202 rows=200) (actual time=0.211..0.531 rows=85 loops=1)
        -> Table scan on s  (cost=202 rows=2000) (actual time=0.197..0.472 rows=2000 loops=1)
    -> Single-row index lookup on <subquery2> using <auto_distinct_key> (schedule_id=s.id)  (cost=224521..224521 rows=1) (actual time=6.6..6.6 rows=1 loops=85)
        -> Materialize with deduplication  (cost=224521..224521 rows=199215) (actual time=561..561 rows=2000 loops=1)
            -> Filter: (cs.status = 'AVAILABLE')  (cost=204600 rows=199215) (actual time=0.609..396 rows=1.78e+6 loops=1)
                -> Table scan on cs  (cost=204600 rows=1.99e+6) (actual time=0.604..254 rows=2e+6 loops=1)

# í›„
-> Nested loop semijoin  (cost=4055 rows=35272) (actual time=0.166..1.68 rows=94 loops=1)
    -> Index lookup on s using idx_concert_schedules_concert_id (concert_id=1)  (cost=15.4 rows=94) (actual time=0.145..0.159 rows=94 loops=1)
    -> Covering index lookup on cs using idx_concert_seats_schedule_status (schedule_id=s.id, status='AVAILABLE')  (cost=2197 rows=375) (actual time=0.016..0.016 rows=1 loops=94)
```

| í•­ëª©                       | ì¸ë±ìŠ¤ ë¯¸ì ìš©                                                                     | ì¸ë±ìŠ¤ ì ìš©                                                                |
|--------------------------|-----------------------------------------------------------------------------|-----------------------------------------------------------------------|
| **ì´ ì‹¤í–‰ ì‹œê°„**              | `actual time=561ms`                                                         | `actual time=1.68ms`                                                  |
| **ì¿¼ë¦¬ ì „ëµ**                | `Nested loop inner join`                                                    | `Nested loop semijoin`                                                |
| **concert_schedules ì ‘ê·¼** | `Table scan on s` (rows=2000)                                               | `Index lookup on s using idx_concert_schedules_concert_id` (rows=94)  |
| **concert_seats ì ‘ê·¼**     | `Table scan on cs` â†’ Filter â†’ Materialize with deduplication                | `Covering index lookup on cs using idx_concert_seats_schedule_status` |
| **cs ì²˜ë¦¬ row ìˆ˜**          | `1.78M` rows ì²˜ë¦¬                                                             | loop ë‹¹ 1 row ì²˜ë¦¬ (ì´ 94 loops)                                          |
| **ì¤‘ë³µ ì œê±°**                | `Materialize with deduplication` í¬í•¨                                         | ì—†ìŒ (index lookupìœ¼ë¡œ í•´ê²°)                                                |
| **ì¶”ê°€ ì—°ì‚° ë¹„ìš©**             | `Single-row index lookup`, `materialize`, `deduplication`, `full scan` ë“± ìˆìŒ | ë‹¨ìˆœ index íƒìƒ‰ë§Œ ìˆ˜í–‰                                                       |
| **ì„±ëŠ¥ ê°œì„ ìœ¨**               | -                                                                           | **ì•½ 99.7% ê°œì„  (560ms â†’ 1.68ms)**                                       |

#### ğŸ” ê²°ê³¼

```log
# ì¸ë±ìŠ¤ ì—†ì´ ì¡°íšŒí•œ ê²°ê³¼ ë¡œê·¸(ì²˜ë¦¬ ì†Œìš” ì‹œê°„: 0.586ms)
server1-1 | 2025-07-31T14:11:13.713Z  INFO 1 --- [hhplus] [nio-8080-exec-6] k.h.b.s.c.a.service.ConcertService : {"startedAt":1753971073127,"method":"getAvailableDates()","endedAt":1753971073713,"timeTaken":586}
```

```sql
-- â• ì¸ë±ìŠ¤ ì¶”ê°€
CREATE INDEX idx_concert_schedules_concert_id ON concert_schedules (concert_id);
CREATE INDEX idx_concert_seats_schedule_status ON concert_seats (schedule_id, status);
```

```log
# ì¸ë±ìŠ¤ ì¶”ê°€ í›„ ì¡°íšŒí•œ ê²°ê³¼ ë¡œê·¸(ì²˜ë¦¬ ì†Œìš© ì‹œê°„: 0.021ms)
server2-1 | 2025-07-31T14:28:33.006Z  INFO 1 --- [hhplus] [nio-8080-exec-10] k.h.b.s.c.a.service.ConcertService : {"startedAt":1753972112985,"method":"getAvailableDates()","endedAt":1753972113006,"timeTaken":21}
```

> ğŸ”¥ ì¿¼ë¦¬ ì‘ë‹µ ì‹œê°„ì´ 0.586msì—ì„œ 0.21msë¡œ ì•½ 64% ê°œì„ 

### ì½˜ì„œíŠ¸ ì˜ˆì•½ ê°€ëŠ¥ ì¢Œì„ ì¡°íšŒ

#### âœ… ì½˜ì„œíŠ¸ ìŠ¤ì¼€ì¥´ ì¡°íšŒ(concertId, date)

```sql
/*
ğŸ’¡ì¿¼ë¦¬ë§Œ ë´ì„œëŠ” ê°ì´ ì˜ ì•ˆì¡íŒë‹¤. ë³„ë¡œ ëŠë¦¬ì§„ ì•Šì„ê²ƒ ê°™ë‹¤.
*/
select cse1_0.id,
       cse1_0.concert_id,
       cse1_0.created_at,
       cse1_0.date,
       cse1_0.updated_at
from concert_schedules cse1_0
where cse1_0.concert_id = ?
  and cse1_0.date = ?;
```

#### ğŸ¯ ì‹¤í–‰ ê³„íš

```text
-> Filter: (cse1_0.`date` = DATE'2026-03-21')  (cost=6.94 rows=9.4) (actual time=0.0983..0.0995 rows=1 loops=1)
    -> Index lookup on cse1_0 using idx_concert_schedules_concert_id (concert_id=1)  (cost=6.94 rows=94) (actual time=0.08..0.0859 rows=94 loops=1)
```

> âŒ ì‹¤í–‰ ê³„íšì„ ë³´ë‹ˆ ì¸ë±ìŠ¤ëŠ” í•„ìš” ì—†ì„ê²ƒ ê°™ë‹¤.

#### âœ… ì˜ˆì•½ ê°€ëŠ¥ ì¢Œì„ ì¡°íšŒ(multi join)

```sql
select cse1_0.id,
       se1_0.number,
       se1_0.price,
       cse1_0.status
from concert_seats cse1_0
         join
     seats se1_0
     on cse1_0.seat_id = se1_0.id
         join
     concert_schedules cse2_0
     on cse1_0.schedule_id = cse2_0.id
where cse2_0.concert_id = ?
  and cse1_0.status = 'AVAILABLE';
```

#### ğŸ¯ ì‹¤í–‰ ê³„íš

```text
-> Nested loop inner join  (cost=45423 rows=35272) (actual time=0.142..497 rows=83854 loops=1)
    -> Nested loop inner join  (cost=33078 rows=35272) (actual time=0.127..452 rows=83854 loops=1)
        -> Covering index lookup on cse2_0 using idx_concert_schedules_concert_id (concert_id=1)  (cost=10.6 rows=94) (actual time=0.0233..0.0755 rows=94 loops=1)
        -> Index lookup on cse1_0 using idx_concert_seats_schedule_status (schedule_id=cse2_0.id, status='AVAILABLE')  (cost=315 rows=375) (actual time=0.196..4.77 rows=892 loops=94)
    -> Single-row index lookup on se1_0 using PRIMARY (id=cse1_0.seat_id)  (cost=0.25 rows=1) (actual time=434e-6..451e-6 rows=1 loops=83854)
```

> âŒ ë‹¤ì¤‘ ì¡°ì¸ì´ë¼ ëŠë¦°ê²ƒ ê°™ì€ë° ì´ì „ì— ë§Œë“¤ì–´ë‘” ì¸ë±ìŠ¤ê°€ íƒ€ì§€ë©´ì„œ, í¬ê²Œ ëŠë¦° ëª¨ìŠµì€ ë³¼ ìˆ˜ ì—†ì—ˆë‹¤.
>> ë‹¤ë§Œ í•´ë‹¹ ì¿¼ë¦¬ëŠ” ë¶ˆí•„ìš”í•œ join ì´ ìˆê³  í…ŒìŠ¤íŠ¸ ë°ì´í„° íŠ¹ì„±ìƒ ë°ì´í„° ë¶„í¬ê°€ í•œìª½ìœ¼ë¡œ ì¹˜ìš°ì³¤ì„ ê°€ëŠ¥ì„±ë„ ìˆê¸° ë•Œë¬¸ì— join ì„ ì—†ì• ëŠ” ë°©í–¥ìœ¼ë¡œ ê°œì„ ì´ í•„ìš”í• ê²ƒ ê°™ë‹¤.

```log
# ê²°ê³¼ ë¡œê·¸(ì²˜ë¦¬ ì†Œìš” ì‹œê°„: 0.035ms)
server1-1 | 2025-07-31T14:53:22.249Z  INFO 1 --- [hhplus] [nio-8080-exec-8] k.h.b.s.c.a.service.ConcertService : {"startedAt":1753973602214,"method":"getAvailableSeats()","endedAt":1753973602249,"timeTaken":35}
```

### í¬ì¸íŠ¸ ì¶©ì „

#### âœ… ìœ ì € ì¡°íšŒ

```sql
select ue1_0.id
from users ue1_0
where ue1_0.user_id = ?
limit ?;
```

#### âœ… ìœ ì € í¬ì¸íŠ¸ ì§€ê°‘ ì¡°íšŒ

```sql
select pwe1_0.id,
       pwe1_0.balance,
       pwe1_0.created_at,
       pwe1_0.updated_at,
       pwe1_0.user_id
from point_wallets pwe1_0
where pwe1_0.user_id = ?;
```

#### âœ… ìœ ì € í¬ì¸íŠ¸ ì§€ê°‘ ì—…ë°ì´íŠ¸

```sql
update
    point_wallets
set balance=?,
    updated_at=?,
    user_id=?
where id = ?;
```

> âŒ 3ê°œ ì¿¼ë¦¬ ëª¨ë‘ ë³„ ë‹¤ë¥¸ ìµœì í™”ê°€ í•„ìš”í•´ ë³´ì´ì§€ ì•ŠëŠ”ë‹¤.

```log
# ê²°ê³¼ ë¡œê·¸(ì²˜ë¦¬ ì†Œìš” ì‹œê°„: 0.055ms)
server1-1 | 2025-07-31T15:11:26.750Z  INFO 1 --- [hhplus] [io-8080-exec-10] k.h.b.s.p.a.service.PointWalletService : {"startedAt":1753974686695,"method":"chargePoint()","endedAt":1753974686750,"timeTaken":55}
```

### ëŒ€ê¸°ì—´ í† í° ë°œê¸‰

#### âœ… í™œì„± í† í° ë³´ìœ  ìœ ë¬´ í™•ì¸

```sql
/*
ğŸ’¡ë­”ê°€ ì¿¼ë¦¬ë§Œ ë³´ë©´ ê·¸ë¦¬ ëŠë¦¬ì§€ ì•Šì„ê²ƒ ê°™ì€ë°..
*/
select qte1_0.id
from queue_tokens qte1_0
where qte1_0.user_id = ?
  and qte1_0.status = ?
limit ?;
```

#### ğŸ¯ ì‹¤í–‰ ê³„íš

```text
-> Limit: 1 row(s)  (cost=20274 rows=1) (actual time=147..147 rows=0 loops=1)
    -> Filter: ((qte1_0.`status` = 'WAITING') and (qte1_0.user_id = 'b2c43e36-7ed0-4914-bf80-9ca674ba1554'))  (cost=20274 rows=1985) (actual time=147..147 rows=0 loops=1)
        -> Table scan on qte1_0  (cost=20274 rows=198492) (actual time=0.132..128 rows=200000 loops=1)
```

> Limit ì´ ìˆì–´ ë³„ë¡œ ëŠë¦¬ì§€ ì•Šì„ê²ƒ ê°™ì€ ì¿¼ë¦¬ì˜€ëŠ”ë° ì‹¤í–‰ê³„íšì„ ë³´ë‹ˆ í’€ìŠ¤ìº”ì„ í•˜ê³ ìˆë‹¤..

```sql
-- â• ì¸ë±ìŠ¤ ì¶”ê°€
CREATE INDEX idx_queue_tokens_user_status ON queue_tokens(user_id, status);
```

#### ğŸ¯ ì¸ë±ìŠ¤ ì ìš© ì „, í›„ ì‹¤í–‰ ê³„íš ë¹„êµ
```text
# ì „
-> Limit: 1 row(s)  (cost=20274 rows=1) (actual time=147..147 rows=0 loops=1)
    -> Filter: ((qte1_0.`status` = 'WAITING') and (qte1_0.user_id = 'b2c43e36-7ed0-4914-bf80-9ca674ba1554'))  (cost=20274 rows=1985) (actual time=147..147 rows=0 loops=1)
        -> Table scan on qte1_0  (cost=20274 rows=198492) (actual time=0.132..128 rows=200000 loops=1)

# í›„
-> Limit: 1 row(s)  (cost=1.1 rows=1) (actual time=0.0271..0.0271 rows=1 loops=1)
    -> Covering index lookup on qte1_0 using idx_queue_tokens_user_status (user_id='a0da4c19-13d6-4899-8e77-66d87f357134', status='WAITING')  (cost=1.1 rows=1) (actual time=0.0165..0.0165 rows=1 loops=1)
```

> í’€ìŠ¤ìº”ì„ í•˜ë˜ ì¿¼ë¦¬ê°€ ì¸ë±ìŠ¤ ì¶”ê°€ ì´í›„ ì»¤ë²„ë§ ì¸ë±ìŠ¤ê°€ ì ìš©ë˜ë©´ì„œ rows ê°œìˆ˜ê°€ ì—„ì²­ë‚˜ê²Œ ì¤„ì–´ë“ ê±¸ ë³¼ ìˆ˜ ìˆë‹¤.

#### âœ… í˜„ì¬ ìˆœë²ˆ + 1 ê°’ ì¡°íšŒ

```sql
/*
ğŸ’¡queue_number ê°€ pk ì•„ë‹ˆê¸° ë•Œë¬¸ì— í’€ìŠ¤ìº”ì´ ë°œìƒí• ê²ƒ ê°™ë‹¤.
*/
SELECT COALESCE(MAX(queue_number), 0) + 1
FROM queue_tokens;
```

```sql
-- â• ì¸ë±ìŠ¤ ì¶”ê°€
CREATE INDEX idx_queue_tokens_queue_number ON queue_tokens(queue_number);
```

#### ğŸ¯ ì¸ë±ìŠ¤ ì ìš© ì „, í›„ ì‹¤í–‰ ê³„íš ë¹„êµ

```text
# ì „
-> Aggregate: max(queue_tokens.queue_number)  (cost=40123 rows=1) (actual time=50.4..50.4 rows=1 loops=1)
    -> Table scan on queue_tokens  (cost=20274 rows=198492) (actual time=0.284..39.1 rows=200000 loops=1)

# í›„
-> Rows fetched before execution  (cost=0..0 rows=1) (actual time=83e-6..125e-6 rows=1 loops=1)
```

> ì¸ë±ìŠ¤ ì¶”ê°€ì „ì—ëŠ” ì˜ˆìƒì²˜ëŸ¼ í’€ìŠ¤ìº”ì´ ë°œìƒí•˜ê³  ìˆë‹¤.  
> ì¸ë±ìŠ¤ ì¶”ê°€ í›„ì—ëŠ” Index Only Scan ìœ¼ë¡œ ë§¤ìš° ì ì€ ë¹„ìš©ìœ¼ë¡œ ì¡°íšŒë¥¼ í•  ìˆ˜ ìˆìœ¼ë©°, ì•„ë§ˆ B-Tree ì¸ë±ìŠ¤ì˜ ê°€ì¥ ë§ˆì§€ë§‰ ê°’ë§Œ ì¡°íšŒ ë˜ëŠ”ê²ƒ ê°™ë‹¤.

### ëŒ€ê¸°ì—´ í† í° ì¡°íšŒ

#### âœ… ëŒ€ê¸°ì—´ í† í° ì¡°íšŒ

```sql
/*
ğŸ’¡user_id ì¡°ê±´ì— ëŒ€í•œ ì¸ë±ìŠ¤ê°€ í•„ìš”í• ê²ƒ ê°™ë‹¤.
*/
select qte1_0.id,
       qte1_0.created_at,
       qte1_0.expires_at,
       qte1_0.queue_number,
       qte1_0.status,
       qte1_0.token,
       qte1_0.updated_at,
       qte1_0.user_id
from queue_tokens qte1_0
where qte1_0.user_id = ?;
```

```sql
-- â• ì¸ë±ìŠ¤ ì¶”ê°€
CREATE INDEX idx_queue_tokens_user_id ON queue_tokens(user_id);
```

#### ğŸ¯ ì¸ë±ìŠ¤ ì ìš© ì „, í›„ ì‹¤í–‰ ê³„íš ë¹„êµ

```text
# ì „
-> Filter: (qte1_0.user_id = 'b2c43e36-7ed0-4914-bf80-9ca674ba1554')  (cost=20274 rows=19849) (actual time=0.171..72.7 rows=1 loops=1)
    -> Table scan on qte1_0  (cost=20274 rows=198492) (actual time=0.165..64 rows=200000 loops=1)

# í›„
-> Index lookup on qte1_0 using idx_queue_tokens_user_status (user_id='b2c43e36-7ed0-4914-bf80-9ca674ba1554')  (cost=0.35 rows=1) (actual time=0.0129..0.0129 rows=0 loops=1)
```

> ì¸ë±ìŠ¤ ì¶”ê°€ ì „ì—ëŠ” í’€ìŠ¤ìº”ì´ ë°œìƒí•˜ë˜ ì¿¼ë¦¬ê°€, ì¸ë±ìŠ¤ ì¶”ê°€ ì´í›„ì—ëŠ” íƒìƒ‰í•˜ëŠ” rowsê°€ ë§¤ìš° ì¤„ì–´ë“ ê±¸ ë³¼ ìˆ˜ ìˆë‹¤.

#### âœ… ìˆœë²ˆ ê²€ì¦

```sql
/*
ğŸ’¡ì œì¼ ê±±ì •ë˜ëŠ” ì¿¼ë¦¬.. ì„œë¸Œ ì¿¼ë¦¬ì— MAX ê¹Œì§€ ì‚¬ìš©í•˜ê³  ìˆë‹¤. ë‚˜ë¦„ ì¿¼ë¦¬ë¡œ ìµœì í™”ë¥¼ í•˜ë ¤ í–ˆëŠ”ë° ì‰½ì§€ ì•Šì€ê²ƒ ê°™ë‹¤.
*/
SELECT MAX(queue_number)
FROM (SELECT queue_number
      FROM queue_tokens
      WHERE status = 'WAITING'
        AND expires_at > NOW()
      ORDER BY queue_number ASC
      LIMIT 10) AS allowed;
```

```log
# ì¸ë±ìŠ¤ ì¶”ê°€ ì „ ë¡œê·¸
server1-1 | 2025-07-31T17:24:25.284Z  INFO 1 --- [hhplus] [nio-8080-exec-6] k.h.b.s.q.a.service.EntryQueueService : {"startedAt":1753982665073,"method":"createEntryQueueToken()","endedAt":1753982665279,"timeTaken":206}
```

```sql
-- â• ì¸ë±ìŠ¤ ì¶”ê°€
CREATE INDEX idx_queue_status_expires_queue ON queue_tokens (status, expires_at, queue_number);
```

#### ğŸ¯ ì¸ë±ìŠ¤ ì ìš© ì „, í›„ ì‹¤í–‰ ê³„íš ë¹„êµ

```text
# ì „
-> Aggregate: max(allowed.queue_number)  (cost=18955..18955 rows=1) (actual time=65.5..65.5 rows=1 loops=1)
    -> Table scan on allowed  (cost=18952..18954 rows=10) (actual time=65.5..65.5 rows=10 loops=1)
        -> Materialize  (cost=18952..18952 rows=10) (actual time=65.5..65.5 rows=10 loops=1)
            -> Limit: 10 row(s)  (cost=18951 rows=10) (actual time=65.4..65.4 rows=10 loops=1)
                -> Sort: queue_tokens.queue_number, limit input to 10 row(s) per chunk  (cost=18951 rows=198492) (actual time=65.4..65.4 rows=10 loops=1)
                    -> Filter: ((queue_tokens.`status` = 'WAITING') and (queue_tokens.expires_at > <cache>(now())))  (cost=18951 rows=198492) (actual time=0.104..63.1 rows=34161 loops=1)
                        -> Table scan on queue_tokens  (cost=18951 rows=198492) (actual time=0.088..39.4 rows=200000 loops=1)

# í›„
-> Aggregate: max(allowed.queue_number)  (cost=5.69..5.69 rows=1) (actual time=0.507..0.507 rows=1 loops=1)
    -> Table scan on allowed  (cost=2.36..4.7 rows=9.86) (actual time=0.5..0.501 rows=10 loops=1)
        -> Materialize  (cost=2.09..2.09 rows=9.86) (actual time=0.497..0.497 rows=10 loops=1)
            -> Limit: 10 row(s)  (cost=1.1 rows=9.86) (actual time=0.0693..0.479 rows=10 loops=1)
                -> Filter: ((queue_tokens.`status` = 'WAITING') and (queue_tokens.expires_at > <cache>(now())))  (cost=1.1 rows=9.86) (actual time=0.0682..0.478 rows=10 loops=1)
                    -> Index scan on queue_tokens using idx_queue_tokens_queue_number  (cost=1.1 rows=51) (actual time=0.0481..0.44 rows=104 loops=1)
```

> ì¸ë±ìŠ¤ ì „ìš© ì „ì—ëŠ” í’€ìŠ¤ìº”ì„ í•˜ë˜ ì¿¼ë¦¬ê°€ ì¸ë±ìŠ¤ ìŠ¤ìº”ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆë‹¤.  
> rows ìˆ˜ê°€ ë§ì´ ì¤„ì–´ë“¤ì—ˆë‹¤. ì—¬ê¸°ì„œ ì¿¼ë¦¬ë¥¼ ì–´ë–»ê²Œ í•˜ë©´ ë” ìµœì í™” ì‹œí‚¬ ìˆ˜ ìˆì„ì§€ ì¡°ê¸ˆ ê¶ê¸ˆí•˜ê¸´ í•˜ë‹¤. ì´ ë¶€ë¶„ì€ ì¢€ ë” ê³µë¶€í•´ë„ ì¢‹ì„ê²ƒ ê°™ì€ë°  
> ì‚¬ì‹¤ ëŒ€ê¸°ì—´ ê´€ë ¨ëœ ë¶€ë¶„ì€ ì¶”í›„ì— redis ë˜ëŠ” kafka ë¡œ ì˜®ê¸¸ ì˜ˆì •ì´ê¸° ë•Œë¬¸ì— ì§€ê¸ˆì€ ì—¬ê¸°ê¹Œì§€ë§Œ í•˜ê³  ë„˜ì–´ê°€ëŠ”ê²Œ ì¢‹ì„ê²ƒ ê°™ê¸°ë„ í•˜ë‹¤.


```log
# ì¸ë±ìŠ¤ ì¶”ê°€ í›„ ë¡œê·¸
server2-1 | 2025-07-31T17:24:51.649Z  INFO 1 --- [hhplus] [nio-8081-exec-5] k.h.b.s.q.a.service.EntryQueueService : {"startedAt":1753982691481,"method":"createEntryQueueToken()","endedAt":1753982691644,"timeTaken":163}
```

> ìƒê°ë³´ë‹¤.. ì„±ëŠ¥ì ìœ¼ë¡œëŠ” ì°¨ì´ê°€ ë³„ë¡œ ì—†ëŠ”ê²ƒê°™ë‹¤. ì‹¤í–‰ ê³„íšì—ì„œëŠ” ì—„ì²­ë‚œ ì°¨ì´ë¥¼ ë³´ì¸ê²ƒ ê°™ì€ë° ë§‰ìƒ ì§ì ‘ ì‚¬ìš©í•´ë³´ë‹ˆ ë°ì´í„°ê°€ ì ì–´ì„œ ê·¸ëŸ°ì§€ í° ì°¨ì´ëŠ” ì—†ì—ˆë‹¤.

### ì˜ˆì•½ ìƒì„±

#### âœ… ì½˜ì„œíŠ¸ ì¢Œì„ ì¡°íšŒ

```sql
select cse1_0.id,
       cse1_0.created_at,
       cse1_0.schedule_id,
       cse1_0.seat_id,
       cse1_0.status,
       cse1_0.updated_at
from concert_seats cse1_0
where cse1_0.id = ?;
```

#### âœ… ì½˜ì„œíŠ¸ ìŠ¤ì¼€ì¥´ ì¡°íšŒ(PK)

```sql
select cse1_0.id,
       cse1_0.concert_id,
       cse1_0.created_at,
       cse1_0.date,
       cse1_0.updated_at
from concert_schedules cse1_0
where cse1_0.id = ?;
```

#### âœ… ì¢Œì„ ì¡°íšŒ

```sql
select se1_0.id,
       se1_0.created_at,
       se1_0.number,
       se1_0.price,
       se1_0.updated_at
from seats se1_0
where se1_0.id = ?;
```

#### âœ… ì½˜ì„œíŠ¸ ì¢Œì„ ìƒíƒœ ì—…ë°ì´íŠ¸

```sql
update
    concert_seats
set schedule_id=?,
    seat_id=?,
    status=?,
    updated_at=?
where id = ?;
```

> âŒ 4ê°œ ì¿¼ë¦¬ ëª¨ë‘ ë³„ ë‹¤ë¥¸ ìµœì í™”ê°€ í•„ìš”í•´ ë³´ì´ì§€ ì•ŠëŠ”ë‹¤.(PK ë¥¼ í†µí•œ ì¡°íšŒ)

```log
# ê²°ê³¼ ë¡œê·¸(ì²˜ë¦¬ ì†Œìš” ì‹œê°„: 0.045ms)
server1-1 | 2025-07-31T15:21:07.173Z  INFO 1 --- [hhplus] [nio-8080-exec-1] k.h.b.s.q.adapter.web.QueueAccessAspect : {"startedAt":1753975267128,"method":"validateQueueAccess()","joinPoint":"makeReservation","endedAt":1753975267173,"timeTaken":45}
```

### ê²°ì œ

#### âœ… ì˜ˆì•½ ëª©ë¡ ì¡°íšŒ

```sql
select re1_0.id,
       re1_0.concert_id,
       re1_0.concert_seat_id,
       re1_0.confirmed_at,
       re1_0.created_at,
       re1_0.expires_at,
       re1_0.payment_id,
       re1_0.reserved_at,
       re1_0.status,
       re1_0.updated_at,
       re1_0.user_id
from reservations re1_0
where re1_0.user_id = ?;
```

#### âœ… ê²°ì œ ëª©ë¡ ì¡°íšŒ

```sql
select pe1_0.id,
       pe1_0.created_at,
       pe1_0.paid_at,
       pe1_0.price,
       pe1_0.status,
       pe1_0.updated_at,
       pe1_0.user_id
from payments pe1_0
where pe1_0.id in (?);
```

#### âœ… í¬ì¸íŠ¸ ì¡°íšŒ

```sql
select pwe1_0.id,
       pwe1_0.balance,
       pwe1_0.created_at,
       pwe1_0.updated_at,
       pwe1_0.user_id
from point_wallets pwe1_0
where pwe1_0.user_id = ?;
```

#### âœ… ëŒ€ê¸°ì—´ í† í° ì¡°íšŒ

```sql
select qte1_0.id,
       qte1_0.created_at,
       qte1_0.expires_at,
       qte1_0.queue_number,
       qte1_0.status,
       qte1_0.token,
       qte1_0.updated_at,
       qte1_0.user_id
from queue_tokens qte1_0
where qte1_0.user_id = ?;
```

#### âœ… ì¢Œì„ ì ìœ  ì œê±°

```sql
delete she1_0
from seat_holds she1_0
where she1_0.id in (?);
```

#### âœ… ì˜ˆì•½ ìƒíƒœ ì—…ë°ì´íŠ¸

```sql
update
    reservations
set concert_id=?,
    concert_seat_id=?,
    confirmed_at=?,
    expires_at=?,
    payment_id=?,
    reserved_at=?,
    status=?,
    updated_at=?,
    user_id=?
where id = ?;
```

#### âœ… ê²°ì œ ìƒíƒœ ì—…ë°ì´íŠ¸

```sql
update
    payments
set paid_at=?,
    price=?,
    status=?,
    updated_at=?,
    user_id=?
where id = ?;
```

#### âœ… ì½˜ì„œíŠ¸ ì¢Œì„ ìƒíƒœ ì—…ë°ì´íŠ¸

```sql
update
    concert_seats
set schedule_id=?,
    seat_id=?,
    status=?,
    updated_at=?
where id = ?;
```

#### âœ… í† í° ìƒíƒœ ì—…ë°ì´íŠ¸

```sql
update
    queue_tokens
set expires_at=?,
    queue_number=?,
    status=?,
    token=?,
    updated_at=?,
    user_id=?
where id = ?;
```

> âŒ ì¿¼ë¦¬ ëª¨ë‘ ë³„ ë‹¤ë¥¸ ìµœì í™”ê°€ í•„ìš”í•´ ë³´ì´ì§€ ì•ŠëŠ”ë‹¤.(PK ë¥¼ í†µí•œ ì¡°íšŒ)

```log
# ê²°ê³¼ ë¡œê·¸(ì²˜ë¦¬ ì†Œìš” ì‹œê°„: 0.201ms)
server1-1 | 2025-07-31T14:12:39.347Z  INFO 1 --- [hhplus] [nio-8080-exec-7] k.h.b.s.q.adapter.web.QueueAccessAspect : {"startedAt":1753971159146,"method":"validateQueueAccess()","joinPoint":"payWithPoints","endedAt":1753971159347,"timeTaken":201}
```

### ì˜ˆì•½ ë§Œë£Œ

#### âœ… ì˜ˆì•½ ì¡°íšŒ(between)

```sql
/*
ğŸ’¡ì˜ˆì•½ í…Œì´ë¸”ì˜ ë°ì´í„°ê°€ ìŒ“ì¼ìˆ˜ë¡ ì¿¼ë¦¬ê°€ ë§¤ìš° ëŠë ¤ì§ˆê²ƒ ê°™ë‹¤.
*/
select re1_0.id,
       re1_0.concert_id,
       re1_0.concert_seat_id,
       re1_0.confirmed_at,
       re1_0.created_at,
       re1_0.expires_at,
       re1_0.payment_id,
       re1_0.reserved_at,
       re1_0.status,
       re1_0.updated_at,
       re1_0.user_id
from reservations re1_0
where re1_0.reserved_at between ? and ?
  and re1_0.status = ?;
```

```sql
-- â• ì¸ë±ìŠ¤ ì¶”ê°€
CREATE INDEX idx_reservations_status_reserved_at ON reservations (status, reserved_at);
```

#### ğŸ¯ ì¸ë±ìŠ¤ ì ìš© ì „, í›„ ì‹¤í–‰ ê³„íš ë¹„êµ

```text
# ì „
-> Filter: ((re1_0.`status` = 'IN_PROGRESS') and (re1_0.reserved_at between '2025-07-31 16:12:01' and '2025-07-31 16:12:05'))  (cost=40587 rows=4418) (actual time=0.901..212 rows=55591 loops=1)
    -> Table scan on re1_0  (cost=40587 rows=397631) (actual time=0.865..177 rows=400000 loops=1)
   
# í›„
-> Filter: ((re1_0.`status` = 'IN_PROGRESS') and (re1_0.reserved_at between '2025-07-31 16:12:01' and '2025-07-31 16:12:05'))  (cost=40510 rows=116740) (actual time=0.956..194 rows=55888 loops=1)
    -> Table scan on re1_0  (cost=40510 rows=397322) (actual time=0.94..156 rows=400000 loops=1)
```

> ì˜ˆìƒê³¼ëŠ” ì „í˜€ ë‹¤ë¥´ê²Œ ì¸ë±ìŠ¤ë¥¼ ì¶”ê°€ í•´ë„ ì—¬ì „íˆ í’€ìŠ¤ìº”ì´ ë°œìƒí•˜ê³  ìˆëŠ” ëª¨ìŠµ. ì˜µí‹°ë§ˆì´ì €ê°€ ë‚´ê°€ ì¶”ê°€í•œ ì¸ë±ìŠ¤ê°€ ë³„ ë„ì›€ì´ ì•ˆëœë‹¤ê³  íŒë‹¨í•œ ëª¨ì–‘ì´ë‹¤.  
> ì´ê±´ ì‚¬ì‹¤ ì¿¼ë¦¬ì— ë¬¸ì œê°€ ìˆë‹¤. SELECT ëª¨ë“  ì»¬ëŸ¼ì„ ë„£ì„ í•„ìš”ê°€ ì—†ëŠ”ë° ëª¨ë‘ ë„£ê³  ìˆì–´ì„œ ì»¤ë²„ë§ ì¸ë±ìŠ¤ë„ í˜ë“  ìƒí™©  
> ë¡œì§ìƒ ëª¨ë“  ì»¬ëŸ¼ ë°ì´í„°ê°€ í•„ìš”ê°€ ì—†ëŠ”ë° ì´ê±´ Projection ë“±ì„ ì‚¬ìš©í•´ì„œ SELECT ì»¬ëŸ¼ ìˆ˜ë¥¼ ì œí•œí•˜ê³  ì»¤ë²„ë§ ì¸ë±ìŠ¤ë¥¼ ì ìš©ì‹œí‚¤ë©´ ê°œì„ ë ê²ƒ ê°™ë‹¤.

```sql
/*
ğŸ’¡ì¡°ê¸ˆ ì „ ìƒì„±í•œ ì¸ë±ìŠ¤ë¡œ ì»¤ë²„ë§ ì¸ë±ìŠ¤ë¥¼ íƒˆ ìˆ˜ ìˆë„ë¡ SELECT ì»¬ëŸ¼ ê°œìˆ˜ ì œí•œ
*/
SELECT re1_0.status, re1_0.reserved_at
FROM reservations re1_0
WHERE re1_0.status = 'IN_PROGRESS'
  AND re1_0.reserved_at BETWEEN '2025-07-31 16:12:01' AND '2025-07-31 16:12:05';
```

```text
-> Filter: ((re1_0.`status` = 'IN_PROGRESS') and (re1_0.reserved_at between '2025-07-31 16:12:01' and '2025-07-31 16:12:05'))  (cost=24676 rows=116740) (actual time=0.596..42.2 rows=55888 loops=1)
    -> Covering index range scan on re1_0 using idx_reservations_status_reserved_at over (status = 'IN_PROGRESS' AND '2025-07-31 16:12:01' <= reserved_at <= '2025-07-31 16:12:05')  (cost=24676 rows=116740) (actual time=0.556..16.1 rows=55888 loops=1)
```

> ë‹¤ì‹œ ì‹¤í–‰ ê³„íšì„ ì‚´í´ë³´ë©´ ì»¤ë²„ë§ ì¸ë±ìŠ¤ë¥¼ íƒ€ëŠ”ê±¸ ë³¼ ìˆ˜ ìˆë‹¤. ì™œ SELECT * ë¥¼ ì‚¬ìš©í•˜ë©´ ì•ˆë˜ëŠ”ì§€ ì•Œìˆ˜ìˆëŠ” ë¶€ë¶„ì´ë‹¤.

#### âœ… ì˜ˆì•½ ìƒíƒœ ì—…ë°ì´íŠ¸

```sql
UPDATE reservations
SET status = :status
WHERE id IN (:ids)
  AND status = 'IN_PROGRESS';
```

> âŒ ë³„ ë‹¤ë¥¸ ìµœì í™”ê°€ í•„ìš”í•´ ë³´ì´ì§€ ì•ŠëŠ”ë‹¤.(PK ë¥¼ í†µí•œ ì¡°íšŒ), status ë¥¼ í¬í•¨í•œ ë³µí•© ì¸ë±ìŠ¤ë¥¼ ë§Œë“¤ì–´ë„ ë˜ì§€ë§Œ ì„±ëŠ¥ì ìœ¼ë¡œ ì´ì ì´ ë§¤ìš° ì ì„ê²ƒìœ¼ë¡œ ì˜ˆìƒë¨  
> ì•„ë˜ ë¹„ìŠ·í•œ ì¿¼ë¦¬ë„ ë§ˆì°¬ê°€ì§€ë¡œ ì†ë„ê°€ ë„ˆë¬´ ëŠë¦¬ê±°ë‚˜ ids ì˜ í¬ê¸°ê°€ ë„ˆë¬´ í° ê²½ìš° ì²­í¬ ì²˜ë¦¬í•  ìˆ˜ ìˆë„ë¡ ì¶”ê°€ í•˜ëŠ”í¸ì´ ì¢‹ì„ê²ƒ ê°™ë‹¤.

#### âœ… ê²°ì œ ìƒíƒœ ì—…ë°ì´íŠ¸

```sql
UPDATE payments
SET status = :status
WHERE id IN (:ids)
  AND status = 'PENDING';
```

> âŒ ë³„ ë‹¤ë¥¸ ìµœì í™”ê°€ í•„ìš”í•´ ë³´ì´ì§€ ì•ŠëŠ”ë‹¤.(PK ë¥¼ í†µí•œ ì¡°íšŒ)

#### âœ… ì¢Œì„ ì ìœ  ì‚­ì œ

```sql
DELETE
FROM seat_holds
WHERE concert_seat_id IN (:concertSeatIds);
```

> âŒ í•´ë‹¹ í…Œì´ë¸”ì€ ë°ì´í„°ë¥¼ ë§ì´ ì €ì¥í•˜ì§€ë„ ì•Šê³ , ì¶”í›„ì— Redis ë¡œ ì˜®ê¸°ëŠ” í¸ì´ ì¢‹ì„ê²ƒ ê°™ë‹¤. ì§€ê¸ˆì€ ë³„ ë‹¤ë¥¸ ìµœì í™”ê°€ í•„ìš” ì—†ì„ê²ƒ ê°™ë‹¤.

#### âœ… ì½˜ì„œíŠ¸ ì¢Œì„ ìƒíƒœ ë³€ê²½

```sql
UPDATE concert_seats
SET status = :status
WHERE id IN (:ids)
  AND status = 'HELD';
```

> âŒ ë³„ ë‹¤ë¥¸ ìµœì í™”ê°€ í•„ìš”í•´ ë³´ì´ì§€ ì•ŠëŠ”ë‹¤.(PK ë¥¼ í†µí•œ ì¡°íšŒ)
